# -*- coding: utf-8 -*-
"""Crop_Yield_Model_Prediction.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1DznPYdB5jNqBPRdaUjat5TNCdLaxoUpD
"""

!pip install pandas numpy scikit-learn joblib

import pandas as pd

yield_df = pd.read_csv("yield.csv")
rainfall = pd.read_csv("rainfall.csv")
temp = pd.read_csv("temp.csv")
pesticides = pd.read_csv("pesticides.csv")

# Function to clean column names: strip whitespace and convert to Title Case
def clean_and_title_cols(df):
    df.columns = [col.strip().title() for col in df.columns]
    return df

# Apply cleaning to all dataframes
yield_df = clean_and_title_cols(yield_df)
rainfall = clean_and_title_cols(rainfall)
temp = clean_and_title_cols(temp)
pesticides = clean_and_title_cols(pesticides)

# Rename specific columns that are known to be different for consistency
# For temp: 'Country' needs to be 'Area'
temp = temp.rename(columns={'Country': 'Area'})

# For yield_df, check for 'Area Code' and 'Year Code' if 'Area' or 'Year' are not directly present
# This is common in FAOSTAT datasets.
if 'Area' not in yield_df.columns and 'Area Code' in yield_df.columns:
    yield_df = yield_df.rename(columns={'Area Code': 'Area'})

if 'Year' not in yield_df.columns and 'Year Code' in yield_df.columns:
    yield_df = yield_df.rename(columns={'Year Code': 'Year'})

# Now merge using the standardized 'Year' and 'Area' column names
df = yield_df.merge(rainfall, on=["Year", "Area"])
df = df.merge(temp, on=["Year", "Area"])
df = df.merge(pesticides, on=["Year", "Area"])

df.head()

df.info()

df.head()

df_model = df[[
    "Area",
    "Item_x",
    "Year",
    "Average_Rain_Fall_Mm_Per_Year",
    "Avg_Temp",
    "Value_y",
    "Value_x"
]]

df_model = df_model.rename(columns={
    "Item_x": "Crop",
    "Average_Rain_Fall_Mm_Per_Year": "Rainfall",
    "Avg_Temp": "Temperature",
    "Value_y": "Pesticide",
    "Value_x": "Yield"
})

df_model.head()

df_model["Rainfall"] = pd.to_numeric(
    df_model["Rainfall"],
    errors="coerce"
)

df_model = df_model.dropna()

df_model.info()

from sklearn.preprocessing import LabelEncoder

label_encoders = {}

for col in ["Area", "Crop"]:
    le = LabelEncoder()
    df_model[col] = le.fit_transform(df_model[col])
    label_encoders[col] = le

X = df_model.drop("Yield", axis=1)
y = df_model["Yield"]

from sklearn.model_selection import train_test_split

X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)

from sklearn.ensemble import RandomForestRegressor

rf_model = RandomForestRegressor(
    n_estimators=200,
    random_state=42,
    n_jobs=-1
)

rf_model.fit(X_train, y_train)

from sklearn.metrics import mean_absolute_error, r2_score

preds = rf_model.predict(X_test)

print("MAE:", mean_absolute_error(y_test, preds))
print("R2 Score:", r2_score(y_test, preds))

import joblib

joblib.dump(rf_model, "crop_yield_model.pkl")
joblib.dump(label_encoders, "label_encoders.pkl")

import joblib

# Load the original model
model = joblib.load("crop_yield_model.pkl")

# Save with maximum compression
joblib.dump(model, "crop_yield_model_compressed.pkl", compress=9)

import joblib

# Load the original model
model = joblib.load("crop_yield_model_compressed.pkl")

# Save with maximum compression
joblib.dump(model, "crop_yield_model_compressed2.pkl", compress=9)

